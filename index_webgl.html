<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>WebGL Font Displayer</title>
    <script src="node_modules/opentype.js/dist/opentype.js"></script>
    <script src="node_modules/earcut/dist/earcut.dev.js"></script>
    <script src="./js/commonFunctions.js"></script>
    <script src='./js/gl-matrix-min.js'></script>
    <script src='./js/webglTools.js'></script>
    <script src='./js/letter-triangularizer.js'></script>
    <script id="shader-vs" type="x-shader/x-vertex">
        attribute vec3 aVertexPosition;
        attribute vec4 aColor;
        uniform mat4 uMVMatrix;
        uniform mat4 uPMatrix;
        varying vec4 vColor;
        void main(void) {
            vColor = aColor;
            gl_Position = uPMatrix * uMVMatrix * vec4(aVertexPosition, 1.0);
        }
    </script>
    <script id="shader-fs" type="x-shader/x-fragment">
        #ifdef GL_ES
            precision highp float;
        #endif
        varying vec4 vColor;

        void main(void) {
            gl_FragColor = vColor;
        }
    </script>
    <script type="text/javascript">
        var chosenFont;
        var canvas = document.getElementById('canvas');
        var vertexBuffer = null;
        var indexBuffer = null;
        var colorBuffer = null;
        var indices = [];
        var vertices = [];
        var colors = [];
        var mvMatrix = mat4.create();
        var pMatrix = mat4.create();
        var letter = 'T';

        opentype.load('fonts/GothamNarrow-Ultra.otf', function(err, font) {
            if (err) {
                alert('Font could not be loaded: ' + err);
            }
            else {
                chosenFont = font;
                initWebGL();
            }
        });

        function initShaderParameters(prg){
            prg.vertexPositionAttribute = glContext.getAttribLocation(prg, "aVertexPosition");
            glContext.enableVertexAttribArray(prg.vertexPositionAttribute);
            prg.colorAttribute = glContext.getAttribLocation(prg, "aColor");
            glContext.enableVertexAttribArray(prg.colorAttribute);
            prg.pMatrixUniform = glContext.getUniformLocation(prg, 'uPMatrix');
            prg.mvMatrixUniform = glContext.getUniformLocation(prg, 'uMVMatrix');
        }
        function initBuffers(){
            indices = [];
            vertices = [];
            colors = [];

            console.log("Draw")
            vertices = LetterTriangularizer.createVertices(letter, 0, 0.5, 1 ,chosenFont)

            for(let i = 0; i < vertices.length; i++){
                colors.push(Math.random());
                colors.push(Math.random());
                colors.push(Math.random());
                colors.push(1.0);
            }

            indices = LetterTriangularizer.createIndicesFromPoints(vertices);
            // console.log("v:"+vertices);
            // console.log("c:"+colors);
            // console.log("i:"+indices);

            vertexBuffer = getVertexBufferWithVertices(vertices);
            indexBuffer = getIndexBufferWithIndices(indices);
            colorBuffer = getVertexBufferWithVertices(colors);
        }
        function drawScene(){
            glContext.clearColor(0.9, 0.9, 1.0, 1.0);
            glContext.enable(glContext.DEPTH_TEST);
            glContext.clear(glContext.COLOR_BUFFER_BIT | glContext.DEPTH_BUFFER_BIT);
            glContext.viewport(0, 0, c_width, c_height);
            mat4.ortho(pMatrix, -1.0, 1.0, -1.0, 1.0, -1.0, 1.0);
            mat4.identity(mvMatrix);
            glContext.uniformMatrix4fv(prg.pMatrixUniform, false, pMatrix);
            glContext.uniformMatrix4fv(prg.mvMatrixUniform, false, mvMatrix);
            glContext.bindBuffer(glContext.ARRAY_BUFFER, vertexBuffer);
            glContext.vertexAttribPointer(prg.vertexPositionAttribute, 3, glContext.FLOAT, false, 0, 0);
            glContext.bindBuffer(glContext.ARRAY_BUFFER, colorBuffer);
            glContext.vertexAttribPointer(prg.colorAttribute, 4, glContext.FLOAT, false, 0, 0);
            glContext.bindBuffer(glContext.ELEMENT_ARRAY_BUFFER, indexBuffer);
            glContext.drawElements(glContext.TRIANGLES, indices.length, glContext.UNSIGNED_SHORT,0);
        }
        function initWebGL(){
            glContext = getGLContext('canvas');
            initProgram();
            initBuffers();
            renderLoop();
        }
    </script>
</head>
<body>
  <div class="main container">
    <canvas id="canvas" width="600" height="700"/>
  </div>
</body>
</html>
